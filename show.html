<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾åæ¨¡æ‹Ÿå™¨å›¾é‰´</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text-color: #2d3748;
            --accent-color: #667eea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--primary-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        /* --- Header Styles --- */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            padding-top: 20px;
        }

        .header h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 4px 6px rgba(0,0,0,0.2);
            letter-spacing: 1px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        /* --- Common Glass Morphism --- */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        /* --- Filters Area --- */
        .filters {
            padding: 25px;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-item label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.95em;
            white-space: nowrap;
        }

        /* Custom Input & Select Styles */
        select, input {
            padding: 10px 16px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            background: #f7fafc;
            color: #4a5568;
            transition: all 0.2s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            min-width: 120px;
        }

        select:focus, input:focus {
            background: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* --- Stats Area --- */
        .stats {
            padding: 20px;
            margin-bottom: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .stat-item:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 1.6em;
            font-weight: 800;
            color: var(--accent-color);
            display: block;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.8em;
            color: #718096;
            font-weight: 500;
        }

        /* --- Grid & Cards --- */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.6);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            background: white;
            z-index: 2;
        }

        .item-image {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 12px;
            margin-bottom: 12px;
            background: radial-gradient(circle at center, #f8f9fa 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 10px;
        }

        .item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
        }

        .item-card:hover .item-image img {
            transform: scale(1.1);
        }

        .item-name {
            font-size: 1em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            text-align: center;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 2.8em;
        }

        .item-tags {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            margin-top: auto;
        }

        .item-type {
            display: inline-block;
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .item-card[data-rarity="S"] .item-type { background: #fed7d7; color: #c53030; }
        .item-card[data-rarity="A"] .item-type { background: #fed7d7; color: #c53030; }
        .item-card[data-rarity="B"] .item-type { background: #fbd38d; color: #975a16; }
        .item-card[data-rarity="C"] .item-type { background: #c3dafe; color: #3c366b; }

        .item-sources-count {
            font-size: 0.7em;
            color: #a0aec0;
        }

        /* --- NEW Loading Animation --- */
        .loading-container {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 0;
            color: white;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.1em;
            letter-spacing: 2px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: white;
            margin: 5vh auto;
            padding: 0;
            border-radius: 24px;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
        }

        .close:hover {
            background: rgba(0,0,0,0.8);
            color: white;
        }

        .modal-body {
            overflow-y: auto;
            padding: 30px;
        }

        .modal-image {
            width: 100%;
            height: 240px;
            background: radial-gradient(circle at center, #f1f2f6, #dfe4ea);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .modal-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.15));
        }

        .modal-header-text {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-name {
            font-size: 1.8em;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .modal-type {
            display: inline-block;
            background: var(--primary-gradient);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(118, 75, 162, 0.3);
        }

        .modal-description {
            color: #4a5568;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: center;
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
        }

        /* --- Updated Sources Section --- */
        .modal-sources {
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }

        .modal-sources-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-sources-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 12px;
        }

        .source-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 8px;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .source-card:hover {
            background: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .source-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .source-image img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .source-name {
            font-size: 0.75em;
            color: #4a5568;
            font-weight: 500;
            word-break: break-word;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .items-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .filter-group { flex-direction: column; align-items: stretch; }
            select, input { width: 100%; }
            .sources-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç²¾åæ¨¡æ‹Ÿå™¨å›¾é‰´</h1>
            <p>åªåŒ…å«ç²¾åæ¨¡æ‹Ÿå™¨ä¸­å‡ºç°è¿‡çš„ç‰©å“</p>
        </div>

        <div class="stats glass-panel">
            <div class="stats-grid" id="stats-container">
                <div class="stat-item"><span class="stat-number">-</span><span class="stat-label">åŠ è½½ä¸­...</span></div>
                <div class="stat-item"><span class="stat-number">-</span><span class="stat-label">åŠ è½½ä¸­...</span></div>
                <div class="stat-item"><span class="stat-number">-</span><span class="stat-label">åŠ è½½ä¸­...</span></div>
                <div class="stat-item"><span class="stat-number">-</span><span class="stat-label">åŠ è½½ä¸­...</span></div>
            </div>
        </div>

        <div class="filters glass-panel">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="rarity-filter">ç¨€æœ‰åº¦</label>
                    <select id="rarity-filter">
                        <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
                        <!-- ç¨€æœ‰åº¦é€‰é¡¹å·²æ›´æ–°ä¸ºä¸­æ–‡ -->
                        <option value="S">ç¨€ä¸–å“è´¨</option>
                        <option value="A">å¥‡çå“è´¨</option>
                        <option value="B">ç‹¬ç‰¹å“è´¨</option>
                        <option value="C">ç½•è§å“è´¨</option>
                        <option value="D">æ™®é€šå“è´¨</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="type-filter">ç±»å‹</label>
                    <select id="type-filter">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="source-filter">æ¥æº</label>
                    <select id="source-filter">
                        <option value="">å…¨éƒ¨æ¥æº</option>
                    </select>
                </div>
                <div class="filter-item" style="flex-grow: 1;">
                    <label for="search-input">æœç´¢</label>
                    <input type="text" id="search-input" placeholder="æœç´¢ç‰©å“åç§°æˆ–æè¿°...">
                </div>
            </div>
        </div>

        <div id="items-container">
            <div class="loading-container">
                <div class="loader-spinner"></div>
                <div class="loading-text">æ­£åœ¨è¯»å–è®°å¿†æ•°æ®...</div>
            </div>
        </div>
    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content glass-panel">
            <div class="close">&times;</div>
            <div class="modal-body">
                <div class="modal-image" id="modal-image"></div>
                <div class="modal-header-text">
                    <div class="modal-name" id="modal-name"></div>
                    <div class="modal-type" id="modal-type"></div>
                </div>
                <div class="modal-description" id="modal-description"></div>
                <div class="modal-sources">
                    <div class="modal-sources-title">è·å–æ¥æº</div>
                    <div class="sources-grid" id="modal-sources"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ItemCollector {
            constructor() {
                this.allItems = {};
                this.listData = [];
                this.rarityFilter = document.getElementById('rarity-filter');
                this.typeFilter = document.getElementById('type-filter');
                this.sourceFilter = document.getElementById('source-filter');
                this.searchInput = document.getElementById('search-input');
                this.itemsContainer = document.getElementById('items-container');
                this.statsContainer = document.getElementById('stats-container');
                this.modal = document.getElementById('itemModal');
                this.modalClose = document.querySelector('.close');
                
                // ç¨€æœ‰åº¦æ˜ å°„è¡¨
                this.rarityMap = {
                    'S': 'ç¨€ä¸–å“è´¨',
                    'A': 'å¥‡çå“è´¨',
                    'B': 'ç‹¬ç‰¹å“è´¨',
                    'C': 'ç½•è§å“è´¨',
                    'D': 'æ™®é€šå“è´¨'
                };
                
                this.typeOrder = [
                    "æ—¶è£…", "éšèº«ç‰©å“", "éšä»", "è¿½å‡»éŸ³ä¹", 
                    "ä¸ªæ€§åŠ¨ä½œ", "ç­‰å¾…åŠ¨ä½œ", "æ¶‚é¸¦", "å¤´åƒ", 
                    "å¤´åƒæ¡†", "å‡çº§é“å…·", "å°è®°", "å½’å®¿å®¶å…·"
                ];
                
                this.init();
            }

            async init() {
                try {
                    const listResponse = await fetch('./more/list.json');
                    if (!listResponse.ok) throw new Error("List file not found");
                    
                    this.listData = await listResponse.json();
                    
                    await this.collectAllItems();
                    
                    this.initFilters();
                    
                    this.displayItems(Object.values(this.allItems));
                    this.updateStats();
                    
                    this.bindModalEvents();
                    
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    this.itemsContainer.innerHTML = `
                        <div class="loading-container">
                            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ˜•</div>
                            <div class="loading-text">åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–ç½‘ç»œè¿æ¥</div>
                            <div style="font-size: 0.8em; margin-top: 10px; opacity: 0.7;">${error.message}</div>
                        </div>`;
                }
            }

            async collectAllItems() {
                const fetchPromises = this.listData.map(async (pool) => {
                    try {
                        const response = await fetch(`./pools/${pool.id}/pool.json`);
                        if (response.ok) {
                            const poolData = await response.json();
                            this.processPoolItems(poolData, pool.name, pool.id);
                            
                            if (pool.award) {
                                this.processAwardItems(pool.award, pool.name);
                            }
                        }
                    } catch (error) {
                        console.warn(`æ— æ³•åŠ è½½ ${pool.id} çš„æ•°æ®:`, error);
                    }
                });

                await Promise.all(fetchPromises);
            }

            processPoolItems(poolData, sourceName, sourceId) {
                const items = poolData.items;
                const rarityOrderMap = { 'S': 1, 'A': 2, 'B': 3, 'C': 4, 'D': 5 };
                
                for (const [rarity, itemList] of Object.entries(items)) {
                    for (const item of itemList) {
                        const itemId = `${item.name}-${item.type}`; 
                        const repeatValue = item.repeat || 0;
                        const rarityOrder = rarityOrderMap[rarity] || 6;
                        
                        if (!this.allItems[itemId]) {
                            this.allItems[itemId] = {
                                ...item,
                                rarity: rarity,
                                repeat: repeatValue,
                                rarityOrder: rarityOrder,
                                sources: [{
                                    name: sourceName,
                                    id: sourceId,
                                    essenceImage: poolData.essenceImage
                                }]
                            };
                        } else {
                            const existingSource = this.allItems[itemId].sources.find(s => s.id === sourceId);
                            if (!existingSource) {
                                this.allItems[itemId].sources.push({
                                    name: sourceName,
                                    id: sourceId,
                                    essenceImage: poolData.essenceImage
                                });
                            }
                        }
                    }
                }
            }

            processAwardItems(awardData, sourceName) {
                for (const [rewardKey, rewardInfo] of Object.entries(awardData)) {
                    const [itemName, itemImg, itemDescription] = rewardInfo;
                    const itemType = "å¤´åƒ";
                    const itemId = `${itemName}-${itemType}`;
                    
                    if (!this.allItems[itemId]) {
                        this.allItems[itemId] = {
                            name: itemName,
                            img: itemImg,
                            type: itemType,
                            description: itemDescription,
                            repeat: 0, 
                            rarityOrder: 6, 
                            sources: [{
                                name: sourceName,
                                id: this.getSourceIdByName(sourceName),
                                essenceImage: null
                            }]
                        };
                    } else {
                        const sourceId = this.getSourceIdByName(sourceName);
                        const existingSource = this.allItems[itemId].sources.find(s => s.id === sourceId);
                        if (!existingSource) {
                            this.allItems[itemId].sources.push({
                                name: sourceName,
                                id: sourceId,
                                essenceImage: null
                            });
                        }
                    }
                }
            }

            getSourceIdByName(sourceName) {
                const source = this.listData.find(pool => pool.name === sourceName);
                return source ? source.id : sourceName;
            }

            initFilters() {
                const allItemsArray = Object.values(this.allItems);
                
                let types = [...new Set(allItemsArray.map(item => item.type))];
                types.sort((a, b) => {
                    const aIndex = this.typeOrder.indexOf(a);
                    const bIndex = this.typeOrder.indexOf(b);
                    const finalAIndex = aIndex === -1 ? this.typeOrder.length : aIndex;
                    const finalBIndex = bIndex === -1 ? this.typeOrder.length : bIndex;
                    return finalAIndex - finalBIndex;
                });

                const sources = [...new Set(this.listData.map(pool => pool.name))].sort();

                this.typeFilter.innerHTML = '<option value="">å…¨éƒ¨ç±»å‹</option>';
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    this.typeFilter.appendChild(option);
                });

                this.sourceFilter.innerHTML = '<option value="">å…¨éƒ¨æ¥æº</option>';
                sources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source;
                    option.textContent = source;
                    this.sourceFilter.appendChild(option);
                });

                this.rarityFilter.addEventListener('change', () => this.filterItems());
                this.typeFilter.addEventListener('change', () => this.filterItems());
                this.sourceFilter.addEventListener('change', () => this.filterItems());
                this.searchInput.addEventListener('input', () => this.filterItems());
            }

            filterItems() {
                // è·å–ä¸‹æ‹‰æ¡†çš„æ˜¾ç¤ºæ–‡æœ¬ï¼Œç„¶ååå‘æŸ¥æ‰¾å¯¹åº”çš„ç¨€æœ‰åº¦å€¼
                const selectedRarityText = this.rarityFilter.options[this.rarityFilter.selectedIndex].text;
                let rarityValue = '';
                if (selectedRarityText !== 'å…¨éƒ¨ç¨€æœ‰åº¦') {
                    for (const [key, value] of Object.entries(this.rarityMap)) {
                        if (value === selectedRarityText) {
                            rarityValue = key;
                            break;
                        }
                    }
                }
                
                const typeValue = this.typeFilter.value;
                const sourceValue = this.sourceFilter.value;
                const searchValue = this.searchInput.value.toLowerCase();

                const filteredItems = Object.values(this.allItems).filter(item => {
                    const rarityMatch = !rarityValue || item.rarity === rarityValue;
                    const typeMatch = !typeValue || item.type === typeValue;
                    const sourceMatch = !sourceValue || item.sources.some(s => s.name === sourceValue);
                    const searchMatch = !searchValue || 
                        item.name.toLowerCase().includes(searchValue) ||
                        (item.description && item.description.toLowerCase().includes(searchValue));
                    
                    return rarityMatch && typeMatch && sourceMatch && searchMatch;
                });

                this.displayItems(filteredItems);
            }

            displayItems(items) {
                if (items.length === 0) {
                    this.itemsContainer.innerHTML = `
                        <div class="loading-container">
                            <div style="font-size: 3em; margin-bottom: 10px; opacity:0.8;">ğŸ”</div>
                            <div class="loading-text">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç‰©å“</div>
                        </div>`;
                    return;
                }

                const sortedItems = this.sortItems(items);

                const itemsHTML = sortedItems.map((item, index) => `
                    <div class="item-card" data-rarity="${item.rarity || 'D'}" onclick='window.itemCollector.showItemModal(${JSON.stringify(item).replace(/'/g, "\\'")})'>
                        <div class="item-image">
                            ${item.img ? `<img src="${item.img}" alt="${item.name}" loading="lazy" onerror="this.parentElement.innerHTML='<span style=\\'color:#999;font-size:0.8em\\'>æš‚æ— å›¾ç‰‡</span>'">` : '<span style="color:#999;font-size:0.8em">æš‚æ— å›¾ç‰‡</span>'}
                        </div>
                        <div class="item-name" title="${item.name}">${item.name}</div>
                        <div class="item-tags">
                            <div class="item-type">${item.type}</div>
                            <div class="item-sources-count">${item.sources.length}ä¸ªè·å–æ¥æº</div>
                        </div>
                    </div>
                `).join('');

                this.itemsContainer.innerHTML = `<div class="items-grid">${itemsHTML}</div>`;
            }

            sortItems(items) {
                return items.sort((a, b) => {
                    if (a.rarityOrder !== b.rarityOrder) {
                        return a.rarityOrder - b.rarityOrder;
                    }
                    
                    const aTypeIndex = this.typeOrder.indexOf(a.type);
                    const bTypeIndex = this.typeOrder.indexOf(b.type);
                    const finalATypeIndex = aTypeIndex === -1 ? this.typeOrder.length : aTypeIndex;
                    const finalBTypeIndex = bTypeIndex === -1 ? this.typeOrder.length : bTypeIndex;
                    
                    if (finalATypeIndex !== finalBTypeIndex) {
                        return finalATypeIndex - finalBTypeIndex;
                    }
                    
                    return a.name.localeCompare(b.name, 'zh-CN');
                });
            }

            showItemModal(item) {
                document.getElementById('modal-name').textContent = item.name;
                document.getElementById('modal-type').textContent = item.type;
                document.getElementById('modal-description').textContent = item.description || 'æš‚æ— è¯¦ç»†æè¿°';
                
                const modalImage = document.getElementById('modal-image');
                if (item.img) {
                    modalImage.innerHTML = `<img src="${item.img}" alt="${item.name}" onerror="this.parentElement.innerHTML='æš‚æ— å›¾ç‰‡'">`;
                } else {
                    modalImage.innerHTML = 'æš‚æ— å›¾ç‰‡';
                }
                
                // å¯¹æ¥æºæŒ‰åç§°è¿›è¡Œæ™ºèƒ½æ’åºï¼ˆæ•°å­—ä¼˜å…ˆå¹¶æŒ‰æ•°å€¼æ’åºï¼‰
                const sortedSources = [...item.sources].sort((a, b) => {
                    return this.intelligentSort(a.name, b.name);
                });
                
                const sourcesList = document.getElementById('modal-sources');
                sourcesList.innerHTML = sortedSources.map(source => {
                    const imageHtml = source.essenceImage ? 
                        `<img src="${source.essenceImage}" alt="${source.name}" onerror="this.parentElement.innerHTML='ğŸ”®'">` : 
                        'ğŸ”®';
                    
                    return `
                        <div class="source-card">
                            <div class="source-image">${imageHtml}</div>
                            <div class="source-name">${source.name}</div>
                        </div>
                    `;
                }).join('');
                
                this.modal.style.display = 'block';
                requestAnimationFrame(() => {
                    this.modal.classList.add('show');
                });
            }

            // æ™ºèƒ½æ’åºå‡½æ•°ï¼šæ•°å­—éƒ¨åˆ†æŒ‰æ•°å€¼æ’åºï¼Œæ–‡å­—éƒ¨åˆ†æŒ‰æ‹¼éŸ³æ’åº
            intelligentSort(a, b) {
                // æå–å­—ç¬¦ä¸²ä¸­çš„æ•°å­—éƒ¨åˆ†
                const numA = this.extractNumbers(a);
                const numB = this.extractNumbers(b);
                
                // å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²éƒ½åŒ…å«æ•°å­—
                if (numA !== null && numB !== null) {
                    // æ¯”è¾ƒæ•°å­—éƒ¨åˆ†
                    if (numA.num !== numB.num) {
                        return numA.num - numB.num;
                    }
                    
                    // å¦‚æœæ•°å­—ç›¸åŒï¼Œæ¯”è¾ƒå‰©ä½™éƒ¨åˆ†
                    const remainingA = a.substring(0, numA.start) + a.substring(numA.end);
                    const remainingB = b.substring(0, numB.start) + b.substring(numB.end);
                    
                    if (remainingA !== remainingB) {
                        return remainingA.localeCompare(remainingB, 'zh-CN');
                    }
                    
                    // å¦‚æœå‰©ä½™éƒ¨åˆ†ä¹Ÿç›¸åŒï¼ŒæŒ‰åŸå§‹å­—ç¬¦ä¸²æ’åº
                    return a.localeCompare(b, 'zh-CN');
                }
                
                // å¦‚æœåªæœ‰ä¸€ä¸ªåŒ…å«æ•°å­—ï¼Œæ•°å­—ä¼˜å…ˆ
                if (numA !== null && numB === null) {
                    return -1;
                }
                if (numA === null && numB !== null) {
                    return 1;
                }
                
                // éƒ½ä¸åŒ…å«æ•°å­—ï¼ŒæŒ‰æ‹¼éŸ³æ’åº
                return a.localeCompare(b, 'zh-CN');
            }

            // æå–å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ªè¿ç»­çš„æ•°å­—
            extractNumbers(str) {
                const match = str.match(/\d+/);
                if (match) {
                    return {
                        num: parseInt(match[0], 10),
                        start: match.index,
                        end: match.index + match[0].length
                    };
                }
                return null;
            }

            bindModalEvents() {
                const closeModal = () => {
                    this.modal.classList.remove('show');
                    setTimeout(() => {
                        this.modal.style.display = 'none';
                    }, 300);
                };

                this.modalClose.onclick = closeModal;

                window.onclick = (event) => {
                    if (event.target === this.modal) closeModal();
                };

                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && this.modal.style.display === 'block') closeModal();
                });
            }

            updateStats() {
                const totalItems = Object.keys(this.allItems).length;
                const typeCount = [...new Set(Object.values(this.allItems).map(item => item.type))].length;
                const sourceCount = this.listData.length;
                const multiSourceItems = Object.values(this.allItems).filter(item => item.sources.length > 1).length;

                const statsHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${totalItems}</span>
                        <span class="stat-label">æ€»ç‰©å“æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${typeCount}</span>
                        <span class="stat-label">ç‰©å“ç±»å‹</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${sourceCount}</span>
                        <span class="stat-label">ç²¾åæ¥æº</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${multiSourceItems}</span>
                        <span class="stat-label">å¤šæ¥æºç‰©å“</span>
                    </div>
                `;

                this.statsContainer.innerHTML = statsHTML;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.itemCollector = new ItemCollector();
        });
    </script>
</body>
</html>